<!-- templates/profile.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .audiometric {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
        .audiometric-btns {
            margin-top: 10px;
        }
        .graph-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>User Profile</h1>
        <div class="profile">
            <p><strong>Hello</strong> {{ user.first_name }}</p>
            <!-- Add more profile information here as needed -->
        </div>

        <!-- Audiometric Analysis Section -->
        <div class="audiometric">
            <h2>Audiometric Analysis</h2>
            <p>Is the sound audible?</p>
            <div class="audiometric-btns">
                <button onclick="checkAudibility(true)" class="audible-btn">Yes</button>
                <button onclick="checkAudibility(false)" class="inaudible-btn">No</button>
            </div>
            <!-- Results display area -->
            <div id="audibility-result"></div>
        </div>

        <!-- Music Graph Section -->
        <div class="graph-container">
            <h2>Music Graph</h2>
            <canvas id="music-graph" width="600" height="300"></canvas>
            <p>Currently playing sound: <span id="current-sound"></span></p>
        </div>

        <form action="/logout" method="GET">
            <input class="logout-btn" type="submit" value="Logout">
        </form>
    </div>

    <!-- JavaScript for audiometric functionality and music graph -->
    <script>
        // Simulated series of sounds
        const sounds = [
            { name: "Sound 1", data: [0.5, 0.8, 0.3, 0.9, 0.6, 0.2] },
            { name: "Sound 2", data: [0.7, 0.4, 0.6, 0.2, 0.5, 0.8] },
            { name: "Sound 3", data: [0.2, 0.6, 0.4, 0.7, 0.9, 0.3] }
        ];

        let currentSoundIndex = 0;
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let graphCanvas = document.getElementById('music-graph');
        let graphContext = graphCanvas.getContext('2d');
        let currentAnalyser = null;

        function playSound(soundData) {
            // Stop previous analyzer if exists
            if (currentAnalyser) {
                currentAnalyser.disconnect();
            }

            // Create a buffer source
            let buffer = audioContext.createBuffer(1, soundData.length, audioContext.sampleRate);
            let bufferData = buffer.getChannelData(0);
            for (let i = 0; i < soundData.length; i++) {
                bufferData[i] = soundData[i];
            }
            let source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);

            // Create and connect an analyzer
            currentAnalyser = audioContext.createAnalyser();
            currentAnalyser.fftSize = 256;
            source.connect(currentAnalyser);
            currentAnalyser.connect(audioContext.destination);

            // Start playing
            source.start();
            document.getElementById('current-sound').innerText = soundData.name;

            // Update graph
            updateGraph(currentAnalyser);
        }

        function updateGraph(analyser) {
            let bufferLength = analyser.frequencyBinCount;
            let dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            graphContext.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
            graphContext.lineWidth = 2;
            graphContext.strokeStyle = 'rgb(0, 0, 0)';
            graphContext.beginPath();

            let sliceWidth = graphCanvas.width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                let v = dataArray[i] / 128.0;
                let y = v * graphCanvas.height / 2;

                if (i === 0) {
                    graphContext.moveTo(x, y);
                } else {
                    graphContext.lineTo(x, y);
                }

                x += sliceWidth;
            }

            graphContext.lineTo(graphCanvas.width, graphCanvas.height / 2);
            graphContext.stroke();
        }

        function checkAudibility(audible) {
            if (audible) {
                document.getElementById('audibility-result').innerHTML = '<p>The sound is audible.</p>';
            } else {
                document.getElementById('audibility-result').innerHTML = '<p>The sound is inaudible.</p>';
            }
        }

        // Initial play of the first sound
        playSound(sounds[currentSoundIndex].data);
    </script>
</body>
</html>
